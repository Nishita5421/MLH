"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _index = _interopRequireDefault(require("./index"));

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class App {
  /**
   * Provides access to the `applications` version 2 endpoint.
   */
  static get PATH() {
    return "/v2/applications";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition App options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options; // Used to facilitate testing of the call to the underlying object

    this._vonage = this.options.vonageOverride || _index.default;
  }

  _convertMethodSignature(name, type, answerUrl, eventUrl, options) {
    var capability = {};

    switch (type) {
      case "voice":
        capability = {
          voice: {
            webhooks: {
              answer_url: {
                address: answerUrl,
                http_method: "GET"
              },
              event_url: {
                address: eventUrl,
                http_method: "POST"
              }
            }
          }
        };
        break;

      case "messages":
        capability = {
          messages: {
            webhooks: {
              inbound_url: {
                address: options.inbound_url,
                http_method: "POST"
              },
              status_url: {
                address: options.status_url,
                http_method: "POST"
              }
            }
          }
        };
        break;

      case "rtc":
        capability = {
          rtc: {
            webhooks: {
              event_url: {
                address: eventUrl,
                http_method: "POST"
              }
            }
          }
        };
        break;
    }

    return {
      name: name,
      capabilities: capability
    };
  }

  _convertApplicationResponse(application) {
    for (var capability in application.capabilities) {
      application[capability] = {
        webhooks: []
      };

      for (var webhook in application.capabilities[capability].webhooks) {
        application[capability].webhooks.push({
          endpoint_type: webhook,
          endpoint: application.capabilities[capability].webhooks[webhook].address,
          http_method: application.capabilities[capability].webhooks[webhook].http_method
        });
      }
    }

    delete application.capabilities;
    return application;
  }

  _convertApplicationListResponse(applicationResponseHandler) {
    return response => {
      response.count = response.total_items;
      response.page_index = response.page;

      for (var i in response._embedded.applications) {
        response._embedded.applications[i] = applicationResponseHandler(response._embedded.applications[i]);
      }

      return response;
    };
  }
  /**
   * TODO: document
   */


  create(name, type, answerUrl, eventUrl, options, callback) {
    var params = {};
    var responseParser = null;

    if (arguments.length > 2) {
      params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
      responseParser = this._convertApplicationResponse;
    } else {
      params = JSON.stringify(name);
      callback = type;
    }

    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: App.PATH,
      method: "POST",
      body: params,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback, callback, false, responseParser);
  }
  /**
   * TODO: document
   */


  get(params, callback) {
    var v2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var responseParser = null;

    if (typeof params !== "object") {
      responseParser = this._convertApplicationResponse;
    } else {
      responseParser = this._convertApplicationListResponse(this._convertApplicationResponse);
    }

    if (v2) {
      responseParser = null;
    }

    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: _Utils.default.createPathWithQuery(App.PATH, params),
      method: "GET",
      body: undefined,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback, callback, false, responseParser);
  }
  /**
   * TODO: document
   */


  update(appId, name, type, answerUrl, eventUrl, options, callback) {
    var params = {};
    var responseParser = null;

    if (arguments.length > 3) {
      params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
      responseParser = this._convertApplicationResponse;
    } else {
      params = JSON.stringify(name);
      callback = type;
    }

    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: "".concat(App.PATH, "/").concat(appId),
      method: "PUT",
      body: params,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback, callback, false, responseParser);
  }
  /**
   * TODO: document
   */


  delete(appId, callback) {
    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: "".concat(App.PATH, "/").concat(appId),
      method: "DELETE",
      body: "{}",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback);
  }

}

var _default = App;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHAuanMiXSwibmFtZXMiOlsiQXBwIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfdm9uYWdlIiwidm9uYWdlT3ZlcnJpZGUiLCJ2b25hZ2UiLCJfY29udmVydE1ldGhvZFNpZ25hdHVyZSIsIm5hbWUiLCJ0eXBlIiwiYW5zd2VyVXJsIiwiZXZlbnRVcmwiLCJjYXBhYmlsaXR5Iiwidm9pY2UiLCJ3ZWJob29rcyIsImFuc3dlcl91cmwiLCJhZGRyZXNzIiwiaHR0cF9tZXRob2QiLCJldmVudF91cmwiLCJtZXNzYWdlcyIsImluYm91bmRfdXJsIiwic3RhdHVzX3VybCIsInJ0YyIsImNhcGFiaWxpdGllcyIsIl9jb252ZXJ0QXBwbGljYXRpb25SZXNwb25zZSIsImFwcGxpY2F0aW9uIiwid2ViaG9vayIsInB1c2giLCJlbmRwb2ludF90eXBlIiwiZW5kcG9pbnQiLCJfY29udmVydEFwcGxpY2F0aW9uTGlzdFJlc3BvbnNlIiwiYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIiLCJyZXNwb25zZSIsImNvdW50IiwidG90YWxfaXRlbXMiLCJwYWdlX2luZGV4IiwicGFnZSIsImkiLCJfZW1iZWRkZWQiLCJhcHBsaWNhdGlvbnMiLCJjcmVhdGUiLCJjYWxsYmFjayIsInBhcmFtcyIsInJlc3BvbnNlUGFyc2VyIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiSlNPTiIsInN0cmluZ2lmeSIsImF1dGhvcml6YXRpb24iLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJjb25maWciLCJob3N0IiwiYXBpSG9zdCIsInBhdGgiLCJtZXRob2QiLCJib2R5IiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJodHRwQ2xpZW50IiwicmVxdWVzdCIsImdldCIsInYyIiwiVXRpbHMiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwidW5kZWZpbmVkIiwidXBkYXRlIiwiYXBwSWQiLCJkZWxldGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxHQUFOLENBQVU7QUFDUjtBQUNGO0FBQ0E7QUFDRSxhQUFXQyxJQUFYLEdBQWtCO0FBQ2hCLFdBQU8sa0JBQVA7QUFDRDtBQUNEO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0VDLEVBQUFBLFdBQVcsQ0FBQ0MsV0FBRCxFQUE0QjtBQUFBLFFBQWRDLE9BQWMsdUVBQUosRUFBSTtBQUNyQyxTQUFLQyxLQUFMLEdBQWFGLFdBQWI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWYsQ0FGcUMsQ0FJckM7O0FBQ0EsU0FBS0UsT0FBTCxHQUFlLEtBQUtGLE9BQUwsQ0FBYUcsY0FBYixJQUErQkMsY0FBOUM7QUFDRDs7QUFFREMsRUFBQUEsdUJBQXVCLENBQUNDLElBQUQsRUFBT0MsSUFBUCxFQUFhQyxTQUFiLEVBQXdCQyxRQUF4QixFQUFrQ1QsT0FBbEMsRUFBMkM7QUFDaEUsUUFBSVUsVUFBVSxHQUFHLEVBQWpCOztBQUNBLFlBQVFILElBQVI7QUFDRSxXQUFLLE9BQUw7QUFDRUcsUUFBQUEsVUFBVSxHQUFHO0FBQ1hDLFVBQUFBLEtBQUssRUFBRTtBQUNMQyxZQUFBQSxRQUFRLEVBQUU7QUFDUkMsY0FBQUEsVUFBVSxFQUFFO0FBQ1ZDLGdCQUFBQSxPQUFPLEVBQUVOLFNBREM7QUFFVk8sZ0JBQUFBLFdBQVcsRUFBRTtBQUZILGVBREo7QUFLUkMsY0FBQUEsU0FBUyxFQUFFO0FBQ1RGLGdCQUFBQSxPQUFPLEVBQUVMLFFBREE7QUFFVE0sZ0JBQUFBLFdBQVcsRUFBRTtBQUZKO0FBTEg7QUFETDtBQURJLFNBQWI7QUFjQTs7QUFDRixXQUFLLFVBQUw7QUFDRUwsUUFBQUEsVUFBVSxHQUFHO0FBQ1hPLFVBQUFBLFFBQVEsRUFBRTtBQUNSTCxZQUFBQSxRQUFRLEVBQUU7QUFDUk0sY0FBQUEsV0FBVyxFQUFFO0FBQ1hKLGdCQUFBQSxPQUFPLEVBQUVkLE9BQU8sQ0FBQ2tCLFdBRE47QUFFWEgsZ0JBQUFBLFdBQVcsRUFBRTtBQUZGLGVBREw7QUFLUkksY0FBQUEsVUFBVSxFQUFFO0FBQ1ZMLGdCQUFBQSxPQUFPLEVBQUVkLE9BQU8sQ0FBQ21CLFVBRFA7QUFFVkosZ0JBQUFBLFdBQVcsRUFBRTtBQUZIO0FBTEo7QUFERjtBQURDLFNBQWI7QUFjQTs7QUFDRixXQUFLLEtBQUw7QUFDRUwsUUFBQUEsVUFBVSxHQUFHO0FBQ1hVLFVBQUFBLEdBQUcsRUFBRTtBQUNIUixZQUFBQSxRQUFRLEVBQUU7QUFDUkksY0FBQUEsU0FBUyxFQUFFO0FBQ1RGLGdCQUFBQSxPQUFPLEVBQUVMLFFBREE7QUFFVE0sZ0JBQUFBLFdBQVcsRUFBRTtBQUZKO0FBREg7QUFEUDtBQURNLFNBQWI7QUFVQTtBQTVDSjs7QUErQ0EsV0FBTztBQUNMVCxNQUFBQSxJQUFJLEVBQUVBLElBREQ7QUFFTGUsTUFBQUEsWUFBWSxFQUFFWDtBQUZULEtBQVA7QUFJRDs7QUFFRFksRUFBQUEsMkJBQTJCLENBQUNDLFdBQUQsRUFBYztBQUN2QyxTQUFLLElBQUliLFVBQVQsSUFBdUJhLFdBQVcsQ0FBQ0YsWUFBbkMsRUFBaUQ7QUFDL0NFLE1BQUFBLFdBQVcsQ0FBQ2IsVUFBRCxDQUFYLEdBQTBCO0FBQ3hCRSxRQUFBQSxRQUFRLEVBQUU7QUFEYyxPQUExQjs7QUFHQSxXQUFLLElBQUlZLE9BQVQsSUFBb0JELFdBQVcsQ0FBQ0YsWUFBWixDQUF5QlgsVUFBekIsRUFBcUNFLFFBQXpELEVBQW1FO0FBQ2pFVyxRQUFBQSxXQUFXLENBQUNiLFVBQUQsQ0FBWCxDQUF3QkUsUUFBeEIsQ0FBaUNhLElBQWpDLENBQXNDO0FBQ3BDQyxVQUFBQSxhQUFhLEVBQUVGLE9BRHFCO0FBRXBDRyxVQUFBQSxRQUFRLEVBQ05KLFdBQVcsQ0FBQ0YsWUFBWixDQUF5QlgsVUFBekIsRUFBcUNFLFFBQXJDLENBQThDWSxPQUE5QyxFQUF1RFYsT0FIckI7QUFJcENDLFVBQUFBLFdBQVcsRUFDVFEsV0FBVyxDQUFDRixZQUFaLENBQXlCWCxVQUF6QixFQUFxQ0UsUUFBckMsQ0FBOENZLE9BQTlDLEVBQXVEVDtBQUxyQixTQUF0QztBQU9EO0FBQ0Y7O0FBRUQsV0FBT1EsV0FBVyxDQUFDRixZQUFuQjtBQUNBLFdBQU9FLFdBQVA7QUFDRDs7QUFFREssRUFBQUEsK0JBQStCLENBQUNDLDBCQUFELEVBQTZCO0FBQzFELFdBQU9DLFFBQVEsSUFBSTtBQUNqQkEsTUFBQUEsUUFBUSxDQUFDQyxLQUFULEdBQWlCRCxRQUFRLENBQUNFLFdBQTFCO0FBQ0FGLE1BQUFBLFFBQVEsQ0FBQ0csVUFBVCxHQUFzQkgsUUFBUSxDQUFDSSxJQUEvQjs7QUFDQSxXQUFLLElBQUlDLENBQVQsSUFBY0wsUUFBUSxDQUFDTSxTQUFULENBQW1CQyxZQUFqQyxFQUErQztBQUM3Q1AsUUFBQUEsUUFBUSxDQUFDTSxTQUFULENBQW1CQyxZQUFuQixDQUFnQ0YsQ0FBaEMsSUFBcUNOLDBCQUEwQixDQUM3REMsUUFBUSxDQUFDTSxTQUFULENBQW1CQyxZQUFuQixDQUFnQ0YsQ0FBaEMsQ0FENkQsQ0FBL0Q7QUFHRDs7QUFFRCxhQUFPTCxRQUFQO0FBQ0QsS0FWRDtBQVdEO0FBRUQ7QUFDRjtBQUNBOzs7QUFDRVEsRUFBQUEsTUFBTSxDQUFDaEMsSUFBRCxFQUFPQyxJQUFQLEVBQWFDLFNBQWIsRUFBd0JDLFFBQXhCLEVBQWtDVCxPQUFsQyxFQUEyQ3VDLFFBQTNDLEVBQXFEO0FBQ3pELFFBQUlDLE1BQU0sR0FBRyxFQUFiO0FBQ0EsUUFBSUMsY0FBYyxHQUFHLElBQXJCOztBQUVBLFFBQUlDLFNBQVMsQ0FBQ0MsTUFBVixHQUFtQixDQUF2QixFQUEwQjtBQUN4QkgsTUFBQUEsTUFBTSxHQUFHSSxJQUFJLENBQUNDLFNBQUwsQ0FDUCxLQUFLeEMsdUJBQUwsQ0FBNkJDLElBQTdCLEVBQW1DQyxJQUFuQyxFQUF5Q0MsU0FBekMsRUFBb0RDLFFBQXBELEVBQThEVCxPQUE5RCxDQURPLENBQVQ7QUFHQXlDLE1BQUFBLGNBQWMsR0FBRyxLQUFLbkIsMkJBQXRCO0FBQ0QsS0FMRCxNQUtPO0FBQ0xrQixNQUFBQSxNQUFNLEdBQUdJLElBQUksQ0FBQ0MsU0FBTCxDQUFldkMsSUFBZixDQUFUO0FBQ0FpQyxNQUFBQSxRQUFRLEdBQUdoQyxJQUFYO0FBQ0Q7O0FBRUQsUUFBTXVDLGFBQWEsYUFBTSxLQUFLN0MsS0FBTCxDQUFXOEMsTUFBakIsY0FBMkIsS0FBSzlDLEtBQUwsQ0FBVytDLFNBQXRDLENBQW5CO0FBRUEsUUFBSUMsTUFBTSxHQUFHO0FBQ1hDLE1BQUFBLElBQUksRUFBRSxLQUFLbEQsT0FBTCxDQUFhbUQsT0FBYixJQUF3QixlQURuQjtBQUVYQyxNQUFBQSxJQUFJLEVBQUV4RCxHQUFHLENBQUNDLElBRkM7QUFHWHdELE1BQUFBLE1BQU0sRUFBRSxNQUhHO0FBSVhDLE1BQUFBLElBQUksRUFBRWQsTUFKSztBQUtYZSxNQUFBQSxPQUFPLEVBQUU7QUFDUCx3QkFBZ0Isa0JBRFQ7QUFFUEMsUUFBQUEsYUFBYSxrQkFBV0MsTUFBTSxDQUFDQyxJQUFQLENBQVlaLGFBQVosRUFBMkJhLFFBQTNCLENBQW9DLFFBQXBDLENBQVg7QUFGTjtBQUxFLEtBQWI7QUFXQSxTQUFLM0QsT0FBTCxDQUFhNEQsVUFBYixDQUF3QkMsT0FBeEIsQ0FDRVosTUFERixFQUVFVixRQUZGLEVBR0VBLFFBSEYsRUFJRSxLQUpGLEVBS0VFLGNBTEY7QUFPRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ0VxQixFQUFBQSxHQUFHLENBQUN0QixNQUFELEVBQVNELFFBQVQsRUFBK0I7QUFBQSxRQUFad0IsRUFBWSx1RUFBUCxLQUFPO0FBQ2hDLFFBQU1qQixhQUFhLGFBQU0sS0FBSzdDLEtBQUwsQ0FBVzhDLE1BQWpCLGNBQTJCLEtBQUs5QyxLQUFMLENBQVcrQyxTQUF0QyxDQUFuQjtBQUNBLFFBQUlQLGNBQWMsR0FBRyxJQUFyQjs7QUFFQSxRQUFJLE9BQU9ELE1BQVAsS0FBa0IsUUFBdEIsRUFBZ0M7QUFDOUJDLE1BQUFBLGNBQWMsR0FBRyxLQUFLbkIsMkJBQXRCO0FBQ0QsS0FGRCxNQUVPO0FBQ0xtQixNQUFBQSxjQUFjLEdBQUcsS0FBS2IsK0JBQUwsQ0FDZixLQUFLTiwyQkFEVSxDQUFqQjtBQUdEOztBQUVELFFBQUl5QyxFQUFKLEVBQVE7QUFDTnRCLE1BQUFBLGNBQWMsR0FBRyxJQUFqQjtBQUNEOztBQUVELFFBQUlRLE1BQU0sR0FBRztBQUNYQyxNQUFBQSxJQUFJLEVBQUUsS0FBS2xELE9BQUwsQ0FBYW1ELE9BQWIsSUFBd0IsZUFEbkI7QUFFWEMsTUFBQUEsSUFBSSxFQUFFWSxlQUFNQyxtQkFBTixDQUEwQnJFLEdBQUcsQ0FBQ0MsSUFBOUIsRUFBb0MyQyxNQUFwQyxDQUZLO0FBR1hhLE1BQUFBLE1BQU0sRUFBRSxLQUhHO0FBSVhDLE1BQUFBLElBQUksRUFBRVksU0FKSztBQUtYWCxNQUFBQSxPQUFPLEVBQUU7QUFDUCx3QkFBZ0Isa0JBRFQ7QUFFUEMsUUFBQUEsYUFBYSxrQkFBV0MsTUFBTSxDQUFDQyxJQUFQLENBQVlaLGFBQVosRUFBMkJhLFFBQTNCLENBQW9DLFFBQXBDLENBQVg7QUFGTjtBQUxFLEtBQWI7QUFXQSxTQUFLM0QsT0FBTCxDQUFhNEQsVUFBYixDQUF3QkMsT0FBeEIsQ0FDRVosTUFERixFQUVFVixRQUZGLEVBR0VBLFFBSEYsRUFJRSxLQUpGLEVBS0VFLGNBTEY7QUFPRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ0UwQixFQUFBQSxNQUFNLENBQUNDLEtBQUQsRUFBUTlELElBQVIsRUFBY0MsSUFBZCxFQUFvQkMsU0FBcEIsRUFBK0JDLFFBQS9CLEVBQXlDVCxPQUF6QyxFQUFrRHVDLFFBQWxELEVBQTREO0FBQ2hFLFFBQUlDLE1BQU0sR0FBRyxFQUFiO0FBQ0EsUUFBSUMsY0FBYyxHQUFHLElBQXJCOztBQUNBLFFBQUlDLFNBQVMsQ0FBQ0MsTUFBVixHQUFtQixDQUF2QixFQUEwQjtBQUN4QkgsTUFBQUEsTUFBTSxHQUFHSSxJQUFJLENBQUNDLFNBQUwsQ0FDUCxLQUFLeEMsdUJBQUwsQ0FBNkJDLElBQTdCLEVBQW1DQyxJQUFuQyxFQUF5Q0MsU0FBekMsRUFBb0RDLFFBQXBELEVBQThEVCxPQUE5RCxDQURPLENBQVQ7QUFHQXlDLE1BQUFBLGNBQWMsR0FBRyxLQUFLbkIsMkJBQXRCO0FBQ0QsS0FMRCxNQUtPO0FBQ0xrQixNQUFBQSxNQUFNLEdBQUdJLElBQUksQ0FBQ0MsU0FBTCxDQUFldkMsSUFBZixDQUFUO0FBQ0FpQyxNQUFBQSxRQUFRLEdBQUdoQyxJQUFYO0FBQ0Q7O0FBRUQsUUFBTXVDLGFBQWEsYUFBTSxLQUFLN0MsS0FBTCxDQUFXOEMsTUFBakIsY0FBMkIsS0FBSzlDLEtBQUwsQ0FBVytDLFNBQXRDLENBQW5CO0FBRUEsUUFBSUMsTUFBTSxHQUFHO0FBQ1hDLE1BQUFBLElBQUksRUFBRSxLQUFLbEQsT0FBTCxDQUFhbUQsT0FBYixJQUF3QixlQURuQjtBQUVYQyxNQUFBQSxJQUFJLFlBQUt4RCxHQUFHLENBQUNDLElBQVQsY0FBaUJ1RSxLQUFqQixDQUZPO0FBR1hmLE1BQUFBLE1BQU0sRUFBRSxLQUhHO0FBSVhDLE1BQUFBLElBQUksRUFBRWQsTUFKSztBQUtYZSxNQUFBQSxPQUFPLEVBQUU7QUFDUCx3QkFBZ0Isa0JBRFQ7QUFFUEMsUUFBQUEsYUFBYSxrQkFBV0MsTUFBTSxDQUFDQyxJQUFQLENBQVlaLGFBQVosRUFBMkJhLFFBQTNCLENBQW9DLFFBQXBDLENBQVg7QUFGTjtBQUxFLEtBQWI7QUFXQSxTQUFLM0QsT0FBTCxDQUFhNEQsVUFBYixDQUF3QkMsT0FBeEIsQ0FDRVosTUFERixFQUVFVixRQUZGLEVBR0VBLFFBSEYsRUFJRSxLQUpGLEVBS0VFLGNBTEY7QUFPRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ0U0QixFQUFBQSxNQUFNLENBQUNELEtBQUQsRUFBUTdCLFFBQVIsRUFBa0I7QUFDdEIsUUFBTU8sYUFBYSxhQUFNLEtBQUs3QyxLQUFMLENBQVc4QyxNQUFqQixjQUEyQixLQUFLOUMsS0FBTCxDQUFXK0MsU0FBdEMsQ0FBbkI7QUFFQSxRQUFJQyxNQUFNLEdBQUc7QUFDWEMsTUFBQUEsSUFBSSxFQUFFLEtBQUtsRCxPQUFMLENBQWFtRCxPQUFiLElBQXdCLGVBRG5CO0FBRVhDLE1BQUFBLElBQUksWUFBS3hELEdBQUcsQ0FBQ0MsSUFBVCxjQUFpQnVFLEtBQWpCLENBRk87QUFHWGYsTUFBQUEsTUFBTSxFQUFFLFFBSEc7QUFJWEMsTUFBQUEsSUFBSSxFQUFFLElBSks7QUFLWEMsTUFBQUEsT0FBTyxFQUFFO0FBQ1Asd0JBQWdCLGtCQURUO0FBRVBDLFFBQUFBLGFBQWEsa0JBQVdDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZWixhQUFaLEVBQTJCYSxRQUEzQixDQUFvQyxRQUFwQyxDQUFYO0FBRk47QUFMRSxLQUFiO0FBV0EsU0FBSzNELE9BQUwsQ0FBYTRELFVBQWIsQ0FBd0JDLE9BQXhCLENBQWdDWixNQUFoQyxFQUF3Q1YsUUFBeEM7QUFDRDs7QUFwUE87O2VBdVBLM0MsRyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgdm9uYWdlIGZyb20gXCIuL2luZGV4XCI7XG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuY2xhc3MgQXBwIHtcbiAgLyoqXG4gICAqIFByb3ZpZGVzIGFjY2VzcyB0byB0aGUgYGFwcGxpY2F0aW9uc2AgdmVyc2lvbiAyIGVuZHBvaW50LlxuICAgKi9cbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi92Mi9hcHBsaWNhdGlvbnNcIjtcbiAgfVxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gQXBwIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICAvLyBVc2VkIHRvIGZhY2lsaXRhdGUgdGVzdGluZyBvZiB0aGUgY2FsbCB0byB0aGUgdW5kZXJseWluZyBvYmplY3RcbiAgICB0aGlzLl92b25hZ2UgPSB0aGlzLm9wdGlvbnMudm9uYWdlT3ZlcnJpZGUgfHwgdm9uYWdlO1xuICB9XG5cbiAgX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucykge1xuICAgIGxldCBjYXBhYmlsaXR5ID0ge307XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFwidm9pY2VcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICB2b2ljZToge1xuICAgICAgICAgICAgd2ViaG9va3M6IHtcbiAgICAgICAgICAgICAgYW5zd2VyX3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFuc3dlclVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJHRVRcIlxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBldmVudF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBldmVudFVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJQT1NUXCJcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwibWVzc2FnZXNcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICBtZXNzYWdlczoge1xuICAgICAgICAgICAgd2ViaG9va3M6IHtcbiAgICAgICAgICAgICAgaW5ib3VuZF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBvcHRpb25zLmluYm91bmRfdXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBzdGF0dXNfdXJsOiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzczogb3B0aW9ucy5zdGF0dXNfdXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJydGNcIjpcbiAgICAgICAgY2FwYWJpbGl0eSA9IHtcbiAgICAgICAgICBydGM6IHtcbiAgICAgICAgICAgIHdlYmhvb2tzOiB7XG4gICAgICAgICAgICAgIGV2ZW50X3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGV2ZW50VXJsLFxuICAgICAgICAgICAgICAgIGh0dHBfbWV0aG9kOiBcIlBPU1RcIlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogbmFtZSxcbiAgICAgIGNhcGFiaWxpdGllczogY2FwYWJpbGl0eVxuICAgIH07XG4gIH1cblxuICBfY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2UoYXBwbGljYXRpb24pIHtcbiAgICBmb3IgKGxldCBjYXBhYmlsaXR5IGluIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllcykge1xuICAgICAgYXBwbGljYXRpb25bY2FwYWJpbGl0eV0gPSB7XG4gICAgICAgIHdlYmhvb2tzOiBbXVxuICAgICAgfTtcbiAgICAgIGZvciAobGV0IHdlYmhvb2sgaW4gYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzW2NhcGFiaWxpdHldLndlYmhvb2tzKSB7XG4gICAgICAgIGFwcGxpY2F0aW9uW2NhcGFiaWxpdHldLndlYmhvb2tzLnB1c2goe1xuICAgICAgICAgIGVuZHBvaW50X3R5cGU6IHdlYmhvb2ssXG4gICAgICAgICAgZW5kcG9pbnQ6XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5jYXBhYmlsaXRpZXNbY2FwYWJpbGl0eV0ud2ViaG9va3Nbd2ViaG9va10uYWRkcmVzcyxcbiAgICAgICAgICBodHRwX21ldGhvZDpcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllc1tjYXBhYmlsaXR5XS53ZWJob29rc1t3ZWJob29rXS5odHRwX21ldGhvZFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkZWxldGUgYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzO1xuICAgIHJldHVybiBhcHBsaWNhdGlvbjtcbiAgfVxuXG4gIF9jb252ZXJ0QXBwbGljYXRpb25MaXN0UmVzcG9uc2UoYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIpIHtcbiAgICByZXR1cm4gcmVzcG9uc2UgPT4ge1xuICAgICAgcmVzcG9uc2UuY291bnQgPSByZXNwb25zZS50b3RhbF9pdGVtcztcbiAgICAgIHJlc3BvbnNlLnBhZ2VfaW5kZXggPSByZXNwb25zZS5wYWdlO1xuICAgICAgZm9yIChsZXQgaSBpbiByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zKSB7XG4gICAgICAgIHJlc3BvbnNlLl9lbWJlZGRlZC5hcHBsaWNhdGlvbnNbaV0gPSBhcHBsaWNhdGlvblJlc3BvbnNlSGFuZGxlcihcbiAgICAgICAgICByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zW2ldXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBjcmVhdGUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICBsZXQgcGFyYW1zID0ge307XG4gICAgbGV0IHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcblxuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikge1xuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHRoaXMuX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucylcbiAgICAgICk7XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShuYW1lKTtcbiAgICAgIGNhbGxiYWNrID0gdHlwZTtcbiAgICB9XG5cbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcblxuICAgIHZhciBjb25maWcgPSB7XG4gICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgIHBhdGg6IEFwcC5QQVRILFxuICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIGJvZHk6IHBhcmFtcyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIGNvbmZpZyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBmYWxzZSxcbiAgICAgIHJlc3BvbnNlUGFyc2VyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgZ2V0KHBhcmFtcywgY2FsbGJhY2ssIHYyID0gZmFsc2UpIHtcbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcbiAgICBsZXQgcmVzcG9uc2VQYXJzZXIgPSBudWxsO1xuXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gdGhpcy5fY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gdGhpcy5fY29udmVydEFwcGxpY2F0aW9uTGlzdFJlc3BvbnNlKFxuICAgICAgICB0aGlzLl9jb252ZXJ0QXBwbGljYXRpb25SZXNwb25zZVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodjIpIHtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcbiAgICB9XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KEFwcC5QQVRILCBwYXJhbXMpLFxuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxuICAgICAgYm9keTogdW5kZWZpbmVkLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJhc2ljICR7QnVmZmVyLmZyb20oYXV0aG9yaXphdGlvbikudG9TdHJpbmcoXCJiYXNlNjRcIil9YFxuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgY29uZmlnLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBjYWxsYmFjayxcbiAgICAgIGZhbHNlLFxuICAgICAgcmVzcG9uc2VQYXJzZXJcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICB1cGRhdGUoYXBwSWQsIG5hbWUsIHR5cGUsIGFuc3dlclVybCwgZXZlbnRVcmwsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGxldCByZXNwb25zZVBhcnNlciA9IG51bGw7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAzKSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShcbiAgICAgICAgdGhpcy5fY29udmVydE1ldGhvZFNpZ25hdHVyZShuYW1lLCB0eXBlLCBhbnN3ZXJVcmwsIGV2ZW50VXJsLCBvcHRpb25zKVxuICAgICAgKTtcbiAgICAgIHJlc3BvbnNlUGFyc2VyID0gdGhpcy5fY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KG5hbWUpO1xuICAgICAgY2FsbGJhY2sgPSB0eXBlO1xuICAgIH1cblxuICAgIGNvbnN0IGF1dGhvcml6YXRpb24gPSBgJHt0aGlzLmNyZWRzLmFwaUtleX06JHt0aGlzLmNyZWRzLmFwaVNlY3JldH1gO1xuXG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogYCR7QXBwLlBBVEh9LyR7YXBwSWR9YCxcbiAgICAgIG1ldGhvZDogXCJQVVRcIixcbiAgICAgIGJvZHk6IHBhcmFtcyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIGNvbmZpZyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBmYWxzZSxcbiAgICAgIHJlc3BvbnNlUGFyc2VyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgZGVsZXRlKGFwcElkLCBjYWxsYmFjaykge1xuICAgIGNvbnN0IGF1dGhvcml6YXRpb24gPSBgJHt0aGlzLmNyZWRzLmFwaUtleX06JHt0aGlzLmNyZWRzLmFwaVNlY3JldH1gO1xuXG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogYCR7QXBwLlBBVEh9LyR7YXBwSWR9YCxcbiAgICAgIG1ldGhvZDogXCJERUxFVEVcIixcbiAgICAgIGJvZHk6IFwie31cIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChjb25maWcsIGNhbGxiYWNrKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBBcHA7XG4iXX0=